{% extends 'base.html' %}
{% load static %}
{% block title %}
  Detalle de oferta
{% endblock title %}

{% block js %}
{% endblock %}

{% block content %}
<h1 class="font-bold text-xl mb-4 ">DETALLES DE LA OFERTA</h1>
<div class="flex space-x-0 items-start">
  <!-- Tarjeta de la oferta -->
   <div class="w-1/2 border border-gray-300 rounded-lg shadow-lg mb-4 mt-4 bg-white p-6 rounded-lg mx-[10px] my-[10px]">
    <h1>Detalles de oferta</h1>
    <h2 class="text-xl font-semibold mb-2">{{ oferta.titulo }}</h2>
    <p class="text-gray-600 mb-4">{{ oferta.descripcion }}</p>

    <h3 class="font-bold text-gray-700">Productos:</h3>
    <ul class="list-disc pl-5">
      {% for producto in oferta.productos.all %}
        <li>{{ producto.nombre }}</li>
      {% endfor %}
    </ul>

    <p class="font-bold text-gray-700 mt-4">Comercio:</p>
    <p>{{ oferta.oferente.nombrecomercio }}</p>

    <div class="flex justify-between items-center mt-4 mb-4">
      <p class="text-gray-600 line-through">Precio normal: ${{ oferta.precio_normal }}</p>
      <p class="text-red-500 font-bold">Oferta: ${{ oferta.precio_oferta }}</p>
    </div>

    <!-- Rating form -->
    <div id="form">
      <form id="ratingForm" action="{% url 'recibir_puntuacion' oferta.id %}" method="POST">
        {% csrf_token %}
        <p class="clasificacion">
          {% if user_ha_votado %}
            <p>Puntuación: {{ calificacion_promedio }}</p>
            {% for i in "12345" %}
              {% if forloop.counter <= calificacion_promedio %}
                <label class="text-3xl" style="color: orange;">★ </label>
              {% else %}
                <label class="text-3xl" style="color: grey;">★</label>
              {% endif %}
            {% endfor %}
            <p>Calificaciones: {{ cantidad_calificaciones }}</p>
          {% else %}
            <style>
              .estrellas {
                font-size: 2rem;
                color: grey;
                cursor: pointer;
                direction: rtl;
              }
              .estrellas:hover,
              .estrellas:hover ~ .estrellas {
                color: orange;
              }
              input[type="radio"]:checked + label,
              input[type="radio"]:checked + label ~ label {
                color: orange;
              }
            </style>
            <p class="clasificacion" style="display: flex; flex-direction: row-reverse; margin-right: 70px;">
              <input id="radio5" type="radio" name="estrellas" value="5" onchange="this.form.submit();" style="display: none;">
              <label for="radio5" class="estrellas">★</label>
              <input id="radio4" type="radio" name="estrellas" value="4" onchange="this.form.submit();" style="display: none;">
              <label for="radio4" class="estrellas">★</label>
              <input id="radio3" type="radio" name="estrellas" value="3" onchange="this.form.submit();" style="display: none;">
              <label for="radio3" class="estrellas">★</label>
              <input id="radio2" type="radio" name="estrellas" value="2" onchange="this.form.submit();" style="display: none;">
              <label for="radio2" class="estrellas">★</label>
              <input id="radio1" type="radio" name="estrellas" value="1" onchange="this.form.submit();" style="display: none;">
              <label for="radio1" class="estrellas">★</label>
            </p>
          {% endif %}
        </p>
      </form>
    </div>

    <div class="flex justify-between items-center mb-4">
      <p>Desde: {{ oferta.fecha_inicio|date:"d/m/Y" }}</p>
      <p>Hasta: {{ oferta.fecha_fin|date:"d/m/Y" }}</p>
    </div>

    <a href="{% url 'siguiente_oferta' oferta.id %}" class="bg-red-600 text-white rounded-r px-1 py-1 hover:bg-red-500">
      Siguiente oferta
    </a>
  </div>

  <!-- Mapa -->
  <div id="map" style="height: 500px; width:100%; position: relative; z-index: 1;"></div>
    
  </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<link rel="stylesheet" href="{% static 'css/L.Icon.Pulse.css' %}">
<script src="{% static 'js/L.Icon.Pulse.js' %}"></script>

<script>
  const ubicacionUsuarioDB = {{ ubicacion_usuario|safe }};
  const ubicacionComercio = {{ ubicacion_comercio|safe }};
  
  const map = L.map('map').setView([0, 0], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  const pulsingIcon = L.icon.pulse({ iconSize: [20, 20], color: 'red' });
  const usuarioMarker = L.marker([0, 0], { icon: pulsingIcon }).addTo(map);

  let currentRoute = null;

  function trazarRuta(origen, destino) {
    if (currentRoute) {
        map.removeControl(currentRoute);
    }
    currentRoute = L.Routing.control({
        waypoints: [
            L.latLng(origen.lat, origen.lng),
            L.latLng(destino.lat, destino.lng)
        ],
        routeWhileDragging: true,
        geocoder: L.Control.Geocoder.nominatim(),
        language: 'es',
        lineOptions: {
            styles: [{ color: 'red', opacity: 0.7, weight: 10 }]
        },
        createMarker: function(i, waypoint, n) {
            if (i === n - 1) {
                return L.marker(waypoint.latLng).bindPopup('Destino');
            } else if (i > 0) {
                return L.marker(waypoint.latLng).bindPopup(`Parada ${i}`);
            }
            return null;
        }
    }).addTo(map);
  }

  const fallbackLocation = {
    lat: ubicacionUsuarioDB.latitud,
    lng: ubicacionUsuarioDB.longitud
  };

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function(position) {
        const userLocation = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        map.setView([userLocation.lat, userLocation.lng], 13);
        usuarioMarker.setLatLng([userLocation.lat, userLocation.lng]).bindPopup('Ubicación actual').openPopup();
        
        // Trazar ruta desde la ubicación actual
        trazarRuta(userLocation, { lat: ubicacionComercio.latitud, lng: ubicacionComercio.longitud });
      },
      function(error) {
        map.setView([fallbackLocation.lat, fallbackLocation.lng], 10);
        L.marker([fallbackLocation.lat, fallbackLocation.lng], { icon: pulsingIcon }).addTo(map).bindPopup('Ubicación predeterminada').openPopup();
        
        // Trazar ruta desde la ubicación predeterminada
        trazarRuta(fallbackLocation, { lat: ubicacionComercio.latitud, lng: ubicacionComercio.longitud });
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  } else {
    map.setView([fallbackLocation.lat, fallbackLocation.lng], 10);
    L.marker([fallbackLocation.lat, fallbackLocation.lng], { icon: pulsingIcon }).addTo(map).bindPopup('Ubicación predeterminada').openPopup();
    
    // Trazar ruta desde la ubicación predeterminada
    trazarRuta(fallbackLocation, { lat: ubicacionComercio.latitud, lng: ubicacionComercio.longitud });
  }
</script>

{% endblock %}
